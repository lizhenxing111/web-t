<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <title></title>
    <script src="../source/jquery-3.3.1.min.js"></script>
    <script src="../source/xlsx.full.min.js"></script>
    <script src="../source/layer/layer.js"></script>
    <link rel="stylesheet" href="../source/layer/layer.css">
    <link rel="stylesheet" href="../source/bootstrap/css/bootstrap.min.css">
</head>
<body>
<input type="file" onchange="importf(this)" />
<div id="demo"></div>
<div>
    <p>

    </p>
</div>
<script>
    /*
    FileReader共有4种读取方法：
    1.readAsArrayBuffer(file)：将文件读取为ArrayBuffer。
    2.readAsBinaryString(file)：将文件读取为二进制字符串
    3.readAsDataURL(file)：将文件读取为Data URL
    4.readAsText(file, [encoding])：将文件读取为文本，encoding缺省值为'UTF-8'
                 */
    var wb;//读取完成的数据
    var rABS = false; //是否将文件读取为二进制字符串

    function importf(obj) {//导入
        if(!obj.files) {
            return;
        }
        var f = obj.files[0];
        var reader = new FileReader();
        reader.onload = function(e) {
            var data = e.target.result;
            if(rABS) {
                wb = XLSX.read(btoa(fixdata(data)), {//手动转化
                    type: 'base64'
                });
            } else {
                wb = XLSX.read(data, {
                    type: 'binary'
                });
            }
            var html=getHtml(wb);
            layer.open({
                type:1,
                content:html,
                area:['500px','400px'],
                title: '请选择表格工作项',
                btn: ['确定', '取消'],
                yes:function (index) {
                    var index=$("#sheetIndex").val();
                    //sheet转换json
                    var sheetData=wb.Sheets[wb.SheetNames[index]];
                    var sheetDataJson=JSON.stringify( XLSX.utils.sheet_to_json(sheetData));
                    document.getElementById("demo").innerHTML= sheetDataJson;
                    //https://github.com/SheetJS/js-xlsx
                    var rowData=getRow(sheetData);
                    $.each(rowData,function (i,value) {
                        console.info(sheetData[value].v);
                    })
                    layer.closeAll();
                }
            });
        };
        if(rABS) {
            reader.readAsArrayBuffer(f);
        } else {
            reader.readAsBinaryString(f);
        }
    }

    function fixdata(data) { //文件流转BinaryString
        var o = "",
            l = 0,
            w = 10240;
        for(; l < data.byteLength / w; ++l) o += String.fromCharCode.apply(null, new Uint8Array(data.slice(l * w, l * w + w)));
        o += String.fromCharCode.apply(null, new Uint8Array(data.slice(l * w)));
        return o;
    }
    //添加页面sheet
    function getHtml(wb) {
        var html='<div>';
        var sheetLength=wb.SheetNames.length;
        for(var i=0;i<=sheetLength-1;i++){
            html+='<label><input type="radio" name="sheetIndex" id="sheetIndex" value="'+i+'" checked>'+wb.SheetNames[i]+'</label><br/>';
        }
        return html+"</div>";
    }
    //获取列名
    function getRow(sheet) {
        /*把excel中范围(A1:B2)转换为 range:{ s: {c: 0, r: 0}, e: {c: 2, r: 4}}
        * s为原点 e为终点
        * 解析 数据为第一列到第三列,第一行到第五行
        * 即   三行五列
        * */
        var range=XLSX.utils.decode_range(sheet['!ref']);
        /*获取所有列的坐标
        * A1 A2 A3....
        *
        * */
        var headers=[];
        for(var R = range.s.c;R<= range.e.c; R++) {
            var address={c: R, r: 0};
            var cell_ref = XLSX.utils.encode_cell(address);
            headers.push(cell_ref);
        }
        return headers;
    }
</script>
</body>
</html>